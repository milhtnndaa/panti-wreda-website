<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Transaksi - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.flex { display: flex; }

        /* CSS BARU DITAMBAHKAN DI SINI */
        .megamendung-background {
            background-image: url('10199570.jpg'); /* Pastikan file ini ada di folder yang sama */
            background-repeat: repeat;
            background-size: 250px auto;
            background-attachment: fixed;
            opacity: 0.1;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #ECFDF5; /* Mengganti bg-gray-100 */
        }
        /* AKHIR DARI CSS BARU */

    </style>
</head>

<body class="bg-gray-100 relative">

    <div class="megamendung-background"></div>

    <header class="bg-white shadow-md relative z-10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Kelola Transaksi</h1>
            <a href="admin.html" class="text-sm font-semibold text-emerald-600 hover:underline">&larr; Kembali ke Dashboard</a>
        </div>
    </header>

    <main class="container mx-auto p-6 relative z-10">
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-semibold mb-4">Tambah Transaksi Baru</h2>
            <form id="form-transaksi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                <div class="lg:col-span-1">
                    <label for="transaksi-laporan-id" class="block text-sm font-medium text-gray-700">Untuk Laporan</label>
                    <select id="transaksi-laporan-id" class="mt-1 w-full px-4 py-2 border rounded-lg bg-white" required><option value="">Pilih...</option></select>
                </div>
                 <div class="lg:col-span-1">
                    <label for="transaksi-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                    <input type="date" id="transaksi-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div class="lg:col-span-1">
                    <label for="transaksi-tipe" class="block text-sm font-medium text-gray-700">Tipe</label>
                    <select id="transaksi-tipe" class="mt-1 w-full px-4 py-2 border rounded-lg bg-white" required><option value="pemasukan">Pemasukan</option><option value="pengeluaran">Pengeluaran</option></select>
                </div>
                <div class="lg:col-span-1">
                    <label for="transaksi-kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                    <select id="transaksi-kategori" class="mt-1 w-full px-4 py-2 border rounded-lg bg-white" required></select>
                </div>
                <div class="lg:col-span-1">
                    <label for="transaksi-deskripsi" class="block text-sm font-medium text-gray-700">Nama/Barang</label>
                    <input type="text" id="transaksi-deskripsi" placeholder="Nama Donatur / Barang" class="mt-1 w-full px-4 py-2 border rounded-lg" required>
                </div>
                 <div class="lg:col-span-1">
                    <label for="transaksi-jumlah" class="block text-sm font-medium text-gray-700">Jumlah</label>
                    <input type="text" id="transaksi-jumlah" placeholder="Jumlah (Rp)" class="mt-1 w-full px-4 py-2 border rounded-lg" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-emerald-400 rounded-lg hover:bg-emerald-600 lg:col-span-6">Tambah Transaksi</button>
            </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4">Daftar Transaksi</h2>
            <select id="filter-laporan" class="w-full md:w-1/3 mb-4 px-4 py-2 border rounded-lg bg-white"><option value="">Pilih Laporan untuk Melihat Transaksi...</option></select>
            <div id="daftar-transaksi" class="overflow-x-auto"></div>
        </div>
    </main>

     <div id="edit-transaksi-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">Edit Transaksi</h3>
            <form id="form-edit-transaksi" class="space-y-4">
                <input type="hidden" id="edit-transaksi-id">
                 <div>
                    <label for="edit-transaksi-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                    <input type="date" id="edit-transaksi-tanggal" class="mt-1 w-full px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="edit-transaksi-tipe" class="block text-sm font-medium text-gray-700">Tipe</label>
                    <select id="edit-transaksi-tipe" class="w-full mt-1 px-4 py-2 border rounded-lg bg-white" required>
                        <option value="pemasukan">Pemasukan</option>
                        <option value="pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-transaksi-kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                    <select id="edit-transaksi-kategori" class="mt-1 w-full px-4 py-2 border rounded-lg bg-white" required></select>
                </div>
                <div>
                    <label for="edit-transaksi-deskripsi" class="block text-sm font-medium text-gray-700">Nama/Barang</label>
                    <input type="text" id="edit-transaksi-deskripsi" placeholder="Nama Donatur / Barang" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                </div>
                <div>
                     <label for="edit-transaksi-jumlah" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                    <input type="text" id="edit-transaksi-jumlah" placeholder="Jumlah (Rp)" class="w-full mt-1 px-4 py-2 border rounded-lg" required>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="cancel-edit-transaksi" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import {getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, deleteDoc,
            serverTimestamp, query, where, orderBy} from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";


        const firebaseConfig = {
  apiKey: "AIzaSyCN5vDFv2vHHwIDN6aLezQcsDSyIEvdWpM",
  authDomain: "wreda-assalam.firebaseapp.com",
  projectId: "wreda-assalam",
  storageBucket: "wreda-assalam.firebasestorage.app",
  messagingSenderId: "1051904934369",
  appId: "1:1051904934369:web:2047f406dad5d1958fd2a0",
  measurementId: "G-S2L0JK0J98"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => { if (!user) window.location.replace('admin.html'); });

        const formatRupiah = (angka, prefix = '') => {
            if(isNaN(angka)) return prefix + '0';
            let number_string = String(angka).replace(/[^,\d]/g, '').toString();
            let sisa = number_string.length % 3;
            let rupiah = number_string.substr(0, sisa);
            let ribuan = number_string.substr(sisa).match(/\d{3}/gi);
            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            return prefix + rupiah;
        };
        
        const parseRupiah = (rupiahString) => {
            return parseInt(String(rupiahString).replace(/[^0-9]/g, '')) || 0;
        };

        const jumlahInput = document.getElementById('transaksi-jumlah');
        const editJumlahInput = document.getElementById('edit-transaksi-jumlah');
        jumlahInput.addEventListener('input', (e) => { e.target.value = formatRupiah(parseRupiah(e.target.value), 'Rp '); });
        editJumlahInput.addEventListener('input', (e) => { e.target.value = formatRupiah(parseRupiah(e.target.value), 'Rp '); });

        const formTransaksi = document.getElementById('form-transaksi');
        const daftarTransaksiContainer = document.getElementById('daftar-transaksi');
        const filterLaporanSelect = document.getElementById('filter-laporan');
        const laporanDropdown = document.getElementById('transaksi-laporan-id');
        const editTransaksiModal = document.getElementById('edit-transaksi-modal');
        const formEditTransaksi = document.getElementById('form-edit-transaksi');
        
        const tipeSelect = document.getElementById('transaksi-tipe');
        const kategoriSelect = document.getElementById('transaksi-kategori');
        const editTipeSelect = document.getElementById('edit-transaksi-tipe');
        const editKategoriSelect = document.getElementById('edit-transaksi-kategori');

        // PERUBAHAN: Menambahkan lebih banyak opsi kategori
        const kategoriPemasukan = `
            <option value="Donasi">Donasi</option>
            <option value="Bantuan Pemerintah">Bantuan Pemerintah</option>
            <option value="Iuran Keluarga">Iuran Keluarga</option>
            <option value="Lainnya">Lainnya</option>
        `;
        const kategoriPengeluaran = `
            <option value="Makanan & Gizi">Makanan & Gizi</option>
            <option value="Obat & Vitamin">Obat & Vitamin</option>
            <option value="Listrik, Air, & Internet">Listrik, Air, & Internet</option>
            <option value="Perawatan Gedung">Perawatan Gedung</option>
            <option value="Gaji Staf">Gaji Staf</option>
            <option value="Kegiatan & Rekreasi">Kegiatan & Rekreasi</option>
            <option value="Lainnya">Lainnya</option>
        `;

        const updateKategoriOptions = (tipe, kategoriElement) => {
            if (tipe === 'pemasukan') {
                kategoriElement.innerHTML = kategoriPemasukan;
            } else {
                kategoriElement.innerHTML = kategoriPengeluaran;
            }
        };

        tipeSelect.addEventListener('change', (e) => updateKategoriOptions(e.target.value, kategoriSelect));
        editTipeSelect.addEventListener('change', (e) => updateKategoriOptions(e.target.value, editKategoriSelect));

        async function loadLaporanBulananOptions() {
            const snapshot = await getDocs(collection(db, "laporanBulanan"));
            const dropdowns = [laporanDropdown, filterLaporanSelect];
            dropdowns.forEach(dropdown => {
                const currentVal = dropdown.value;
                dropdown.innerHTML = `<option value="">Pilih Laporan...</option>`;
                snapshot.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.data().bulanTahun || doc.data().bulanTahunText || '(Tanpa Nama)';
                    dropdown.appendChild(option);
                });
                dropdown.value = currentVal;
            });
        }

        async function loadDaftarTransaksi(laporanId) {
            if (!laporanId) {
                daftarTransaksiContainer.innerHTML = '<p class="text-gray-500">Pilih laporan di atas untuk melihat transaksi.</p>';
                return;
            }
            daftarTransaksiContainer.innerHTML = 'Memuat...';
            const q = query(collection(db, "transaksi"), where("laporanId", "==", laporanId), orderBy("tanggal", "desc"));
            const snapshot = await getDocs(q);
            daftarTransaksiContainer.innerHTML = snapshot.empty ? '<p class="text-gray-500">Belum ada transaksi.</p>' : '';
            
            const table = document.createElement('table');
            table.className = 'w-full text-left table-auto';
            table.innerHTML = `
                <thead class="border-b-2">
                    <tr>
                        <th class="py-2 px-4">Tanggal</th>
                        <th class="py-2 px-4">Tipe</th>
                        <th class="py-2 px-4">Kategori</th>
                        <th class="py-2 px-4">Nama/Barang</th>
                        <th class="py-2 px-4 text-right">Jumlah</th>
                        <th class="py-2 px-4 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            snapshot.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement('tr');
                tr.className = `border-b ${data.tipe === 'pengeluaran' ? 'bg-red-50' : ''}`;
                tr.innerHTML = `
                    <td class="py-2 px-4">${new Date(data.tanggal.toDate()).toLocaleDateString('id-ID')}</td>
                    <td class="py-2 px-4">${data.tipe}</td>
                    <td class="py-2 px-4">${data.kategori || '-'}</td>
                    <td class="py-2 px-4">${data.deskripsi}</td>
                    <td class="py-2 px-4 text-right font-semibold ${data.tipe === 'pemasukan' ? 'text-green-600' : 'text-red-600'}">${formatRupiah(data.jumlah, 'Rp ')}</td>
                    <td class="py-2 px-4 text-right">
                        <button class="edit-transaksi-btn text-blue-500 hover:underline mr-2" data-id="${doc.id}">Edit</button>
                        <button class="hapus-transaksi-btn text-red-500 hover:underline" data-id="${doc.id}">Hapus</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            daftarTransaksiContainer.appendChild(table);

            document.querySelectorAll('.edit-transaksi-btn').forEach(btn => btn.addEventListener('click', e => openEditTransaksiModal(e.target.dataset.id)));
            document.querySelectorAll('.hapus-transaksi-btn').forEach(btn => btn.addEventListener('click', e => hapusTransaksi(e.target.dataset.id)));
        }
        
        formTransaksi.addEventListener('submit', async (e) => {
             e.preventDefault();
             const laporanId = laporanDropdown.value;
             if (!laporanId) return alert('Pilih laporan bulanan terlebih dahulu.');

             const dataToSave = {
                laporanId,
                tanggal: new Date(document.getElementById('transaksi-tanggal').value),
                tipe: tipeSelect.value,
                kategori: kategoriSelect.value,
                deskripsi: document.getElementById('transaksi-deskripsi').value,
                jumlah: parseRupiah(document.getElementById('transaksi-jumlah').value),
                createdAt: serverTimestamp()
             };
             
             await addDoc(collection(db, "transaksi"), dataToSave);
             alert('Transaksi berhasil ditambahkan!');
             formTransaksi.reset();
             tipeSelect.dispatchEvent(new Event('change'));
             filterLaporanSelect.value = laporanId;
             loadDaftarTransaksi(laporanId);
        });

        async function openEditTransaksiModal(id) {
            const docRef = doc(db, "transaksi", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('edit-transaksi-id').value = id;
                document.getElementById('edit-transaksi-tanggal').valueAsDate = data.tanggal.toDate();
                editTipeSelect.value = data.tipe;
                
                updateKategoriOptions(data.tipe, editKategoriSelect);
                editKategoriSelect.value = data.kategori || '';
                
                document.getElementById('edit-transaksi-deskripsi').value = data.deskripsi;
                document.getElementById('edit-transaksi-jumlah').value = formatRupiah(data.jumlah, 'Rp ');
                editTransaksiModal.classList.add('flex');
            }
        }
        
        formEditTransaksi.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-transaksi-id').value;
            const data = {
                tanggal: new Date(document.getElementById('edit-transaksi-tanggal').value),
                tipe: editTipeSelect.value,
                kategori: editKategoriSelect.value,
                deskripsi: document.getElementById('edit-transaksi-deskripsi').value,
                jumlah: parseRupiah(document.getElementById('edit-transaksi-jumlah').value),
            };
            await setDoc(doc(db, "transaksi", id), data, { merge: true });
            alert('Transaksi berhasil diperbarui!');
            editTransaksiModal.classList.remove('flex');
            loadDaftarTransaksi(filterLaporanSelect.value);
        });
        
        document.getElementById('cancel-edit-transaksi').addEventListener('click', () => editTransaksiModal.classList.remove('flex'));
        
        async function hapusTransaksi(id) {
            if (confirm("Yakin ingin menghapus transaksi ini?")) {
                await deleteDoc(doc(db, "transaksi", id));
                alert("Transaksi berhasil dihapus.");
                loadDaftarTransaksi(filterLaporanSelect.value);
            }
        }

        filterLaporanSelect.addEventListener('change', (e) => loadDaftarTransaksi(e.target.value));

        loadLaporanBulananOptions();
        updateKategoriOptions(tipeSelect.value, kategoriSelect);
    </script>
</body>
</html>